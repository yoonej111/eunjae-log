# 옵티미스틱 롤업 and OP-Stack

### 옵티미스틱 롤업이란?
옵티미스틱 롤업은 사기 증명 방식을 채택한 대표적인 레이어 2 솔루션

#### 사기 증명(Fraud Proof)
사기 증명 방식은 레이어 2에서 처리된 트랜잭션들을 일정 기간 신뢰하고, 오류가 발견될 경우에만 이를 수정하는 방식이다.

**작동 방식**
    1. 레이어 2에서 트랜잭션을 처리하고 새로운 상태를 생성한다.
    2. 생성된 상태를 레이어 1에 제출한다.
    3. 일정 기간 동안 다른 참여자들이 제출된 상태에 대한 오류를 제기할 수 있다.
    4. 오류가 발견되면 상태를 롤백하고 오류를 제기한 사람에게 보상이 지급된다.

사기 증명 방식에서는 해당 데이터에 오류나 조작이 없을 것이라는 **낙관적인(OPTIMISTIC)** 가정을 세우고 일단 믿는다. 그렇기 때문에, 레이어 2의 주체가 결과를 제출할 때마다 이에 대한 추가적인 검증과 연산이 즉각 적으로 이루어지지 않는다. 추가적인 검증과 연산이 필요하다는 점은 값싼 트랜잭션 비용을 의미할 수 있다.

만약, 시퀀서가 모두의 낙관적인 신뢰를 깨트리고 악의적인 행동을 한 경우, 트랜잭션의 처리 결과를 다시 제대로 되돌릴 수 있도록 옵티미스틱 롤업에는 시퀀서가 결과를 제출한 이후 7일 간의 분쟁 기간을 둔다. 분쟁 기간이 모두 지나기 전까지는 결과가 최종 확정된 것이 아니며, 누구나 의의를 제기할 수 있다. 만약, 누군가가 의의를 제기할 경우, 일종의 재판이라고 할 수 있는 사기 증명이 진행된다. 증명 과정에서 악의적인 행동을 한 것으로 판명되면, 이의를 제기한 자에게는 인센티브, 시퀀서에게는 페널티가 주어지게 된다.


### OP-Stack
- OP-Stack은 옵티미스틱 롤업을 구축할 수 있도록 제공되는 오픈소스 코드  
https://github.com/ethereum-optimism/optimism
- Optimism 에서 개발한 모듈식 소프트웨어 스택으로, Optimism 생태계 내에서 다양한 롤업 체인을 쉽게 구축하고 운영할 수 있도록 하는 표준화된 프레임워크 제공

#### OP-Stack 아키텍쳐

OP-Stack 은 네 가지 요소로 구성되어 있다.
- 노드(op-geth, op-node), 시퀀서 노드(op-batcher, op-propser)

##### op-geth

- **역할**: `op-geth`는 레이어 2에서 발생하는 트랜잭션을 실제로 처리하는 부분
- **어떻게 작동하는지?**: 사용자가 레이어 2에서 트랜잭션을 보내면, `op-geth`는 이 트랜잭션을 받아 현재 상태(State)에 적용하여 새로운 상태로 업데이트

**1️⃣ op-geth의 핵심 역할**

- **레이어 2 실행 환경 제공:** op-geth는 레이어 2에서 스마트 컨트랙트가 실행될 수 있는 환경을 제공한다. 즉, 이더리움 가상 머신(EVM)과 유사한 환경에서 스마트 컨트랙트를 실행하고 상태를 업데이트한다.
- **트랜잭션 처리 및 상태 업데이트:** 사용자들이 제출한 트랜잭션을 순차적으로 처리하고, 이에 따라 레이어 2의 상태를 변경한
- **OP 스택과의 연동:** OP 스택의 다른 구성 요소들과 긴밀하게 협력하여 레이어 2 네트워크를 구성한다. 예를 들어, 시퀀서와 함께 작동하여 트랜잭션을 배치로 묶고, 검증자와 함께 작동하여 상태 증명을 생성한다.

**2️⃣ op-geth의 작동 방식**

1. **트랜잭션 수신:** op-geth는 레이어 2 네트워크에서 발생하는 모든 트랜잭션을 수신한다.
2. **트랜잭션 검증:** 수신된 트랜잭션의 유효성을 검증하고, 가스 비용을 계산한다.
3. **상태 전환:** 유효한 트랜잭션에 대해 현재 상태를 업데이트한다. 이는 스마트 컨트랙트의 실행을 포함하며, 상태 트리라는 자료 구조를 통해 효율적으로 관리된다.
4. **블록 생성:** 일정 시간 또는 일정량의 트랜잭션이 모이면 블록을 생성한다. 생성된 블록에는 트랜잭션 목록과 새로운 상태 루트가 포함된다.
5. **블록 전파:** 생성된 블록을 다른 노드에 전파하여 네트워크 합의를 이룹니다.

**3️⃣ op-geth의 특징**

- **EVM 호환성:** 이더리움 가상 머신(EVM)과 호환되므로 기존 이더리움 생태계의 스마트 컨트랙트를 재사용 가능하다.
- **고성능:** 많은 수의 트랜잭션을 효율적으로 처리할 수 있도록 최적화되어 있다.
- **보안성:** 이더리움의 보안 모델을 기반으로 하여 높은 수준의 보안을 제공한다.
- **확장성:** OP 스택의 모듈형 설계를 통해 다양한 기능을 추가하고 커스터마이징 할 수 있다.

**4️⃣ op-geth의 중요성**

op-geth는 Optimism 레이어2 솔루션의 핵심 구성 요소로, 레이어 2에서 스마트 컨트랙트가 안전하고 효율적으로 실행될 수 있도록 하는 역할을 한다. 이를 통해 이더리움의 확장성 문제를 해결하고, 더 많은 사용자들이 이더리움 생태계를 이용할 수 있도록 한다.


##### op-node

- **역할**: `op-node`는 레이어 2에서 필요한 데이터를 이더리움 메인체인(레이어 1)에서 받아와 가공하는 역할
- **어떻게 작동하는지?**: `op-node`는 이더리움 블록체인에서 가져온 데이터를 분석하고, 이를 `op-geth`가 이해하고 처리할 수 있는 형태로 변환

**1️⃣ op-node의 핵심 역할**

- Optimism 레이어 2 시스템에서 레이어 1과 레이어 2 사이의 다리 역할을 수행한다. 레이어 2 에서 필요한 데이터를 레이어 1에서 가져와 레이어 2 실행 환경인 op-geth 가 처리할 수 있도록 변환해주는 역할을 한다.

**2️⃣ op-node의 작동 방식**

1. **레이어 1 데이터 수집:** op-node는 이더리움 메인넷에서 새로운 블록이 생성될 때마다 해당 블록의 정보를 수집한다. 특히, 레이어 2와 관련된 상태 변화나 이벤트 로그 등을 집중적으로 수집한다.
2. **데이터 변환:** 수집한 데이터를 op-geth가 이해할 수 있는 형태로 변환한다. 이 과정에서 필요한 데이터만 추출하고 불필요한 데이터는 제거하여 op-geth의 처리 부담을 줄인다.
3. **데이터 전달:** 변환된 데이터를 op-geth에 전달하여 레이어 2의 상태를 업데이트하는 데 사용한다.

**3️⃣ op-node가 수행하는 주요 작업**

- **L1 블록 헤더 추적:** 이더리움 메인넷의 최신 블록 헤더를 지속적으로 추적한다.
- **L1 상태 증명 검증:** 레이어 2에서 생성된 상태 증명이 이더리움 메인넷의 상태와 일치하는지 검증한다.
- **L1 이벤트 로그 처리:** 이더리움 메인넷에서 발생하는 이벤트 로그를 분석하고, 레이어 2에 필요한 정보를 추출한다.
- **L2 상태 업데이트:** op-geth에 전달된 데이터를 기반으로 레이어 2의 상태를 업데이트한다.

**4️⃣ op-node의 중요성**

op-node는 레이어 2 시스템의 **데이터 소스** 역할을 하며, 레이어 2의 **보안성**을 유지하는 데 중요한 역할을 한다. 만약 op-node가 없다면 레이어 2는 이더리움 메인넷과 완전히 독립적인 시스템이 되어 버리고, 이는 레이어 2의 신뢰성을 저해할 수 있다.

##### 시퀀서 (op-batcher, op-propser)

- **역할**: 시퀀서는 레이어 2 네트워크에서 트랜잭션을 수집하고 처리한 후(by op-batcher), 새로운 블록을 생성하여 네트워크에 제출하는 역할(by op-propser)을 한다. 또한, 여러 트랜잭션을 하나의 배치로 묶어 이더리움 메인체인(레이어 1)에 전송하는 중요한 역할을 수행한다. 이를 통해 네트워크의 처리 효율을 높이고, 비용을 절감한다.
- **어떻게 작동하는지?**: 시퀀서는 레이어 2 네트워크에서 발생한 트랜잭션을 실시간으로 수집하여 순서를 정하고, 이를 블록으로 묶어 네트워크에 전파한다. 또한, 시퀀서는 일정 주기로 트랜잭션을 배치(batch) 형태로 이더리움 메인체인에 제출하여 트랜잭션 기록을 보존하고, 레이어 1과 레이어 2 간의 상태 동기화를 유지한다.

1️⃣ **시퀀서의 역할**

- **트랜잭션 수집:** 레이어 2 네트워크에서 생성된 다양한 트랜잭션들을 수집한다.
- **트랜잭션 배치:** 수집된 트랜잭션들을 특정 크기 또는 시간 간격에 따라 배치를 구성한다.
- **트랜잭션 순서 정렬:** 배치 내에서 트랜잭션들의 순서를 정한다. 이는 상태 변화의 순서를 보장하고, 재정렬 공격을 방지하기 위해 중요하다.
- **블록 생성:** 구성된 배치를 기반으로 새로운 블록을 생성한다.
- **블록 제안:** 생성된 블록을 레이어 1에 제안하여 최종 확정을 받는다.

2️⃣ **시퀀서의 중요성**

- **효율성 증대:** 개별 트랜잭션을 하나씩 처리하는 것보다 배치를 구성하여 처리함으로써 가스 비용을 절약하고 처리 속도를 향상시킨다.
- **보안 강화:** 트랜잭션 순서를 정하고 배치를 구성함으로써 재정렬 공격을 방지하고 시스템의 보안을 강화한다.
- **유연성:** 다양한 트랜잭션 유형과 가스 가격 모델을 지원하여 유연한 시스템 구성을 가능하게 한다.

3️⃣ **시퀀서의 작동 방식**

1. **트랜잭션 수집:** 레이어 2 노드에서 생성된 트랜잭션들을 mempool에 수집한다.
2. **배치 구성:** 수집된 트랜잭션들을 특정 기준(가스 사용량, 시간 등)에 따라 배치를 구성한다.
3. **트랜잭션 순서 정렬:** 배치 내에서 트랜잭션들의 순서를 정한다. 일반적으로, 더 높은 가스 가격을 제시한 트랜잭션이 먼저 포함된다.
4. **블록 생성:** 순서가 정해진 배치를 기반으로 새로운 블록을 생성한다.
5. **블록 제안:** 생성된 블록을 레이어 1에 제안하여 최종 확정을 받는다. 레이어 1에서 블록이 검증되고 확정되면, 레이어 2의 상태가 업데이트된다.